<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>WebSocket Chat with Gallery & Media</title>
  <style>
    /* ===========================
       CSS RESET & BASE STYLES
       =========================== */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    :root {
      /* Updated Color Palette from StoryScape */
      --background: hsl(222, 22%, 7%);
      --foreground: hsl(210, 40%, 98%);
      --card: hsla(0, 0%, 100%, 0.1);
      --card-foreground: hsl(210, 40%, 98%);
      --primary: hsl(280, 100%, 70%);
      --secondary: hsl(195, 100%, 50%);
      --accent: hsl(318, 100%, 80%);
      --border: hsla(0, 0%, 100%, 0.2);
      --input: hsla(0, 0%, 100%, 0.1);
      --muted-foreground: hsl(215, 16%, 65%);
      --story-overlay: hsla(222, 22%, 7%, 0.8);
      
      /* Compatibility variables */
      --bg-primary: hsl(222, 22%, 7%);
      --bg-secondary: hsla(0, 0%, 100%, 0.1);
      --bg-tertiary: hsla(0, 0%, 100%, 0.15);
      --bg-card: hsla(0, 0%, 100%, 0.08);
      --bg-input: hsla(0, 0%, 100%, 0.1);
      --bg-overlay: hsla(222, 22%, 7%, 0.95);
      
      --text-primary: hsl(210, 40%, 98%);
      --text-secondary: hsl(215, 16%, 65%);
      --text-muted: hsl(215, 20%, 45%);
      --text-accent: hsl(210, 40%, 98%);
      
      --accent-primary: hsl(280, 100%, 70%);
      --accent-secondary: hsl(195, 100%, 50%);
      --accent-gradient: linear-gradient(135deg, 
          var(--primary) 0%, 
          var(--secondary) 50%,
          var(--accent) 100%);
      
      --success: hsl(142, 76%, 36%);
      --warning: hsl(45, 93%, 47%);
      --error: hsl(0, 84%, 60%);
      --info: hsl(217, 91%, 60%);
      
      --border-light: hsla(0, 0%, 100%, 0.1);
      --border-medium: hsla(0, 0%, 100%, 0.2);
      --border-heavy: hsla(0, 0%, 100%, 0.3);
      
      --shadow-sm: 0 2px 8px hsla(0, 0%, 0%, 0.3);
      --shadow-md: 0 4px 16px hsla(0, 0%, 0%, 0.4);
      --shadow-lg: 0 8px 32px hsla(0, 0%, 0%, 0.5);
      --shadow-xl: 0 16px 48px hsla(0, 0%, 0%, 0.6);
      
      --radius-sm: 6px;
      --radius-md: 12px;
      --radius-lg: 16px;
      --radius-xl: 24px;
      --radius-full: 9999px;
      
      /* Spacing */
      --space-xs: 4px;
      --space-sm: 8px;
      --space-md: 16px;
      --space-lg: 24px;
      --space-xl: 32px;
      --space-2xl: 48px;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--background);
      color: var(--foreground);
      line-height: 1.6;
      height: 100dvh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
    }
    
    /* ===========================
       TYPOGRAPHY
       =========================== */
    h1, h2, h3, h4, h5, h6 {
      font-weight: 600;
      line-height: 1.2;
    }
    
    /* ===========================
       UTILITY CLASSES
       =========================== */
    .hidden {
      display: none !important;
    }
    
    .visually-hidden {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }
    
    /* ===========================
       LOGIN MODAL
       =========================== */
    #loginModal {
      position: fixed;
      inset: 0;
      background: var(--bg-overlay);
      backdrop-filter: blur(8px);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      padding: var(--space-md);
    }
    
    .modal-content {
      background: var(--card);
      border-radius: var(--radius-xl);
      padding: var(--space-2xl);
      width: 100%;
      max-width: 440px;
      box-shadow: var(--shadow-xl);
      border: 1px solid var(--border);
      animation: modalSlideIn 0.4s cubic-bezier(0.16, 1, 0.3, 1);
    }
    
    @keyframes modalSlideIn {
      from {
        opacity: 0;
        transform: translateY(20px) scale(0.98);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }
    
    .modal-content h2 {
      text-align: center;
      margin-bottom: var(--space-xl);
      background: var(--accent-gradient);
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
      font-size: 28px;
    }
    
    .form-group {
      margin-bottom: var(--space-lg);
    }
    
    .form-group label {
      display: block;
      margin-bottom: var(--space-sm);
      font-size: 14px;
      font-weight: 500;
      color: var(--muted-foreground);
    }
    
    .form-control {
      width: 100%;
      padding: 14px 16px;
      background: var(--input);
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      color: var(--foreground);
      font-size: 16px;
      transition: all 0.3s ease;
      min-height: 48px;
      box-shadow: inset 0 2px 4px hsla(222, 22%, 7%, 0.1);
    }
    
    .form-control:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px hsla(280, 100%, 70%, 0.2);
    }
    
    .form-control::placeholder {
      color: var(--muted-foreground);
    }
    
    .profile-pic-section {
      display: flex;
      align-items: center;
      gap: var(--space-lg);
    }
    
    .profile-preview {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: var(--input);
      border: 2px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      flex-shrink: 0;
    }
    
    .profile-preview img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .profile-pic-upload {
      flex: 1;
    }
    
    .file-upload-btn {
      display: block;
      width: 100%;
      padding: 14px 16px;
      background: var(--input);
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      color: var(--muted-foreground);
      cursor: pointer;
      text-align: center;
      transition: all 0.3s ease;
      min-height: 48px;
    }
    
    .file-upload-btn:hover {
      border-color: var(--primary);
      color: var(--foreground);
    }
    
    .start-btn {
      position: relative;
      overflow: hidden;
      width: 100%;
      padding: 16px;
      background: var(--accent-gradient);
      color: white;
      border: none;
      border-radius: var(--radius-md);
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      margin-top: var(--space-md);
      min-height: 56px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: var(--space-sm);
    }
    
    .start-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 30px hsla(0, 0%, 0%, 0.3);
    }
    
    /* ===========================
       TOAST STYLES
       =========================== */
    .toast {
      position: fixed;
      top: 1rem;
      right: 1rem;
      z-index: 50;
      padding: 1rem;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 0.5rem;
      box-shadow: var(--shadow-xl);
      transform: translateX(100%);
      transition: transform 0.3s ease;
    }
    
    .toast.show {
      transform: translateX(0);
    }
    
    .toast.error {
      border-color: var(--error);
    }
    
    .toast-title {
      font-weight: 600;
      margin-bottom: 0.25rem;
    }
    
    .toast-description {
      font-size: 0.875rem;
      color: var(--muted-foreground);
    }
    
    /* ===========================
       MAIN CHAT LAYOUT
       =========================== */
    #mainChat {
      display: flex;
      flex: 1;
      position: relative;
      min-height: 0;
      width: 100%;
    }
    
    /* ===========================
       SIDEBAR STYLES
       =========================== */
    .sidebar-toggle {
      position: fixed;
      left: 0;
      top: 50%;
      transform: translateY(-50%);
      background: var(--card);
      color: var(--foreground);
      border: 1px solid var(--border);
      border-left: none;
      border-radius: 0 var(--radius-md) var(--radius-md) 0;
      padding: var(--space-md) var(--space-sm);
      cursor: pointer;
      z-index: 100;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      backdrop-filter: blur(10px);
      min-height: 48px;
      min-width: 48px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .sidebar-toggle:hover {
      background: var(--bg-tertiary);
      transform: translateY(-50%) scale(1.05);
    }
    
    .gallery-sidebar {
      width: 320px;
      background: var(--card);
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      position: fixed;
      left: 0;
      top: 0;
      bottom: 0;
      z-index: 90;
      transform: translateX(-100%);
      transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
      overflow: hidden;
      height: 100dvh;
    }
    
    .gallery-sidebar.open {
      transform: translateX(0);
      box-shadow: var(--shadow-xl);
    }
    
    /* Sidebar overlay for mobile */
    .sidebar-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 85;
      backdrop-filter: blur(2px);
      display: none;
    }
    
    body.sidebar-open .sidebar-overlay {
      display: block;
    }
    
    .gallery-header {
      padding: var(--space-lg);
      border-bottom: 1px solid var(--border);
      flex-shrink: 0;
    }
    
    .gallery-header h3 {
      font-size: 18px;
      color: var(--foreground);
      display: flex;
      align-items: center;
      gap: var(--space-sm);
    }
    
    .gallery-actions {
      padding: var(--space-md);
      display: flex;
      gap: var(--space-sm);
      border-bottom: 1px solid var(--border);
      flex-shrink: 0;
    }
    
    .action-btn {
      flex: 1;
      padding: 12px;
      background: var(--input);
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      color: var(--foreground);
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: var(--space-sm);
      font-size: 14px;
      min-height: 48px;
    }
    
    .action-btn:hover {
      background: var(--bg-tertiary);
      transform: translateY(-2px);
    }
    
    .action-btn.refresh {
      border-color: var(--info);
      color: var(--info);
    }
    
    .action-btn.shutdown {
      border-color: var(--error);
      color: var(--error);
    }
    
    .upload-section {
      padding: var(--space-lg);
      border-bottom: 1px solid var(--border);
      flex-shrink: 0;
    }
    
    .upload-section h4 {
      margin-bottom: var(--space-md);
      color: var(--muted-foreground);
      font-size: 14px;
      font-weight: 500;
    }
    
    .upload-btn {
      position: relative;
      overflow: hidden;
      width: 100%;
      padding: 14px;
      background: var(--accent-gradient);
      color: white;
      border: none;
      border-radius: var(--radius-md);
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: var(--space-sm);
      min-height: 48px;
    }
    
    .upload-btn:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }
    
    .upload-progress {
      margin-top: var(--space-md);
      background: var(--input);
      border-radius: var(--radius-full);
      overflow: hidden;
      height: 6px;
      display: none;
    }
    
    .upload-progress-bar {
      height: 100%;
      background: var(--accent-gradient);
      width: 0%;
      transition: width 0.3s ease;
    }
    
    .upload-status {
      font-size: 12px;
      margin-top: var(--space-sm);
      text-align: center;
      color: var(--muted-foreground);
      display: none;
    }
    
    .listings-container {
      flex: 1;
      overflow-y: auto;
      padding: var(--space-md);
      min-height: 0;
      -webkit-overflow-scrolling: touch;
    }
    
    .listing-item {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      padding: var(--space-md);
      margin-bottom: var(--space-md);
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      min-height: 48px;
    }
    
    .listing-item:hover {
      background: var(--bg-tertiary);
      border-color: var(--border-heavy);
      transform: translateY(-2px);
    }
    
    .listing-item.active {
      background: hsla(280, 100%, 70%, 0.1);
      border-color: var(--primary);
    }
    
    .listing-title {
      font-weight: 600;
      color: var(--foreground);
      margin-bottom: var(--space-xs);
      font-size: 14px;
      word-break: break-word;
    }
    
    .listing-description {
      font-size: 12px;
      color: var(--muted-foreground);
      margin-bottom: var(--space-sm);
      line-height: 1.4;
      word-break: break-word;
    }
    
    .listing-meta {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 11px;
      color: var(--muted-foreground);
    }
    
    .media-count {
      background: var(--success);
      color: white;
      padding: 2px 8px;
      border-radius: var(--radius-full);
      font-size: 10px;
      font-weight: 600;
    }
    
    .selected-badge {
      position: absolute;
      top: -6px;
      right: -6px;
      background: var(--primary);
      color: white;
      font-size: 10px;
      font-weight: 600;
      padding: 3px 8px;
      border-radius: var(--radius-full);
    }
    
    /* ===========================
       CHAT MAIN AREA
       =========================== */
    .chat-main {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-height: 0;
      width: 100%;
      position: relative;
      background: var(--background);
    }
    
    .header {
      background: var(--card);
      padding: var(--space-md) var(--space-lg);
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid var(--border);
      flex-wrap: wrap;
      gap: var(--space-md);
      flex-shrink: 0;
      animation: float 6s ease-in-out infinite;
    }
    
    .user-info, .ai-info {
      display: flex;
      align-items: center;
      gap: var(--space-sm);
    }
    
    .user-name, .ai-name {
      padding: 6px 12px;
      background: var(--input);
      border-radius: var(--radius-full);
      font-size: 14px;
      font-weight: 500;
      word-break: break-word;
      max-width: 150px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    
    .ai-pic {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid var(--border);
    }
    
    .current-listing {
      padding: 6px 16px;
      background: var(--input);
      border-radius: var(--radius-full);
      font-size: 14px;
      color: var(--muted-foreground);
      display: flex;
      align-items: center;
      gap: var(--space-sm);
      max-width: 300px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      word-break: break-word;
    }
    
    .chat-container {
      flex: 1;
      overflow-y: auto;
      padding: var(--space-lg);
      background: var(--background);
      display: flex;
      flex-direction: column;
      gap: var(--space-lg);
      min-height: 0;
      -webkit-overflow-scrolling: touch;
    }
    
    .message {
      max-width: 75%;
      display: flex;
      flex-direction: column;
      animation: messageSlideIn 0.3s ease-out;
    }
    
    @keyframes messageSlideIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .message.user {
      align-self: flex-end;
      align-items: flex-end;
    }
    
    .message.bot {
      align-self: flex-start;
      align-items: flex-start;
    }
    
    .message-header {
      display: flex;
      align-items: center;
      gap: var(--space-sm);
      margin-bottom: 8px;
      padding: 0 4px;
    }
    
    .message-header .profile-pic {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid var(--border);
    }
    
    .message-header .name {
      font-size: 13px;
      font-weight: 500;
      color: var(--muted-foreground);
      word-break: break-word;
    }
    
    .bubble {
      padding: 14px 18px;
      border-radius: var(--radius-lg);
      line-height: 1.6;
      font-size: 15px;
      max-width: 100%;
      word-wrap: break-word;
      word-break: break-word;
      box-shadow: var(--shadow-sm);
    }
    
    .user .bubble {
      background: var(--accent-gradient);
      color: white;
      border-bottom-right-radius: var(--radius-sm);
    }
    
    .bot .bubble {
      background: var(--card);
      color: var(--foreground);
      border: 1px solid var(--border);
      border-bottom-left-radius: var(--radius-sm);
    }
    
    .message-time {
      font-size: 11px;
      color: var(--muted-foreground);
      margin-top: 4px;
      padding: 0 4px;
    }
    
    /* Media in chat */
    .media-container {
      margin-top: var(--space-md);
      border-radius: var(--radius-md);
      overflow: hidden;
      box-shadow: var(--shadow-md);
      max-width: 400px;
    }
    
    .media-item {
      width: 100%;
      max-height: 300px;
      object-fit: contain;
      background: var(--background);
      display: block;
    }
    
    .media-label {
      font-size: 12px;
      color: var(--muted-foreground);
      margin-top: 8px;
      padding: 0 4px;
      font-style: italic;
      word-break: break-word;
    }
    
    .media-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
      gap: var(--space-sm);
      margin-top: var(--space-md);
    }
    
    .media-grid-item {
      width: 100%;
      aspect-ratio: 1;
      border-radius: var(--radius-sm);
      overflow: hidden;
      cursor: pointer;
      position: relative;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .media-grid-item:hover {
      transform: scale(1.05);
    }
    
    .media-grid-item img,
    .media-grid-item video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    /* Typing indicator */
    .typing-indicator {
      align-self: flex-start;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      padding: var(--space-md);
      display: flex;
      align-items: center;
      gap: var(--space-md);
      margin-bottom: var(--space-md);
      animation: typingSlideIn 0.3s ease-out;
      max-width: 200px;
      flex-shrink: 0;
    }
    
    .typing-dots {
      display: flex;
      gap: 4px;
    }
    
    .typing-dots span {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--primary);
      opacity: 0.4;
      animation: typingBounce 1.4s infinite ease-in-out;
    }
    
    .typing-dots span:nth-child(2) { animation-delay: -0.16s; }
    .typing-dots span:nth-child(3) { animation-delay: -0.32s; }
    
    @keyframes typingBounce {
      0%, 60%, 100% {
        transform: translateY(0);
        opacity: 0.4;
      }
      30% {
        transform: translateY(-4px);
        opacity: 1;
      }
    }
    
    /* Input area */
    .input-area {
      padding: var(--space-lg);
      background: var(--card);
      border-top: 1px solid var(--border);
      display: flex;
      gap: var(--space-md);
      flex-shrink: 0;
      position: sticky;
      bottom: 0;
      padding-bottom: max(var(--space-lg), env(safe-area-inset-bottom));
    }
    
    .input-area input {
      flex: 1;
      padding: 16px 20px;
      background: var(--input);
      border: 1px solid var(--border);
      border-radius: var(--radius-full);
      color: var(--foreground);
      font-size: 16px;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      min-height: 48px;
      box-shadow: inset 0 2px 4px hsla(222, 22%, 7%, 0.1);
    }
    
    .input-area input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px hsla(280, 100%, 70%, 0.2);
    }
    
    .input-area input::placeholder {
      color: var(--muted-foreground);
    }
    
    .input-area button {
      position: relative;
      overflow: hidden;
      padding: 14px 28px;
      background: var(--accent-gradient);
      color: white;
      border: none;
      border-radius: var(--radius-full);
      font-size: 15px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: var(--space-sm);
      min-width: 100px;
      min-height: 48px;
    }
    
    .input-area button:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }
    
    /* ===========================
       SCROLLBAR STYLING
       =========================== */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }
    
    ::-webkit-scrollbar-track {
      background: var(--input);
      border-radius: 4px;
    }
    
    ::-webkit-scrollbar-thumb {
      background: var(--border);
      border-radius: 4px;
      transition: background 0.2s ease;
    }
    
    ::-webkit-scrollbar-thumb:hover {
      background: var(--primary);
    }
    
    /* ===========================
       ANIMATIONS
       =========================== */
    @keyframes float {
      0%, 100% {
        transform: translateY(0px);
      }
      50% {
        transform: translateY(-5px);
      }
    }
    
    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
    
    /* ===========================
       RESPONSIVE DESIGN
       =========================== */
    
    /* Desktop (1024px and above) */
    @media (min-width: 1024px) {
      .gallery-sidebar {
        position: relative;
        transform: translateX(0);
        height: 100%;
        box-shadow: none;
      }
      
      .gallery-sidebar.open {
        transform: translateX(0);
        box-shadow: none;
      }
      
      body.sidebar-open .sidebar-overlay {
        display: none !important;
      }
      
      .sidebar-toggle {
        display: none;
      }
      
      .header {
        padding: var(--space-lg) var(--space-xl);
      }
      
      .chat-container {
        padding: var(--space-xl);
        gap: var(--space-xl);
      }
      
      .input-area {
        padding: var(--space-xl);
      }
      
      .media-grid {
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
        gap: var(--space-md);
      }
    }
    
    /* Tablet (768px to 1023px) */
    @media (max-width: 1023px) and (min-width: 768px) {
      .gallery-sidebar {
        width: 300px;
      }
      
      .header {
        padding: var(--space-lg);
      }
      
      .chat-container {
        padding: var(--space-lg);
      }
      
      .message {
        max-width: 80%;
      }
      
      .input-area {
        padding: var(--space-lg);
      }
      
      .media-grid {
        grid-template-columns: repeat(auto-fill, minmax(90px, 1fr));
      }
    }
    
    /* Mobile (767px and below) */
    @media (max-width: 767px) {
      .sidebar-toggle {
        display: flex;
        padding: 12px 8px;
      }
      
      .gallery-sidebar {
        position: fixed;
        transform: translateX(-100%);
        width: 85vw;
        max-width: 320px;
      }
      
      #loginModal {
        padding: var(--space-sm);
      }
      
      .modal-content {
        padding: var(--space-xl);
        margin: var(--space-sm);
      }
      
      .modal-content h2 {
        font-size: 24px;
        margin-bottom: var(--space-lg);
      }
      
      .profile-pic-section {
        flex-direction: column;
        gap: var(--space-md);
      }
      
      .profile-preview {
        width: 64px;
        height: 64px;
      }
      
      .header {
        padding: var(--space-md);
        gap: var(--space-sm);
        flex-direction: column;
        align-items: stretch;
      }
      
      .user-info, .ai-info {
        justify-content: center;
      }
      
      .current-listing {
        order: 3;
        width: 100%;
        justify-content: center;
        max-width: 100%;
        margin-top: var(--space-xs);
        font-size: 13px;
        padding: 8px 16px;
      }
      
      .user-name,
      .ai-name {
        font-size: 13px;
        padding: 8px 16px;
        max-width: 120px;
      }
      
      .ai-pic {
        width: 32px;
        height: 32px;
      }
      
      .chat-container {
        padding: var(--space-md);
        gap: var(--space-md);
      }
      
      .message {
        max-width: 90%;
      }
      
      .bubble {
        padding: 12px 16px;
        font-size: 15px;
      }
      
      .input-area {
        padding: var(--space-md);
        flex-direction: column;
        gap: var(--space-sm);
        padding-bottom: max(var(--space-md), env(safe-area-inset-bottom));
      }
      
      .input-area input {
        padding: 14px 18px;
        font-size: 16px;
      }
      
      .input-area button {
        width: 100%;
        padding: 16px;
        min-height: 52px;
      }
      
      .media-grid {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .upload-btn,
      .action-btn {
        padding: 16px;
      }
      
      .media-container {
        max-width: 100%;
      }
    }
    
    /* Small Mobile (480px and below) */
    @media (max-width: 480px) {
      .modal-content {
        padding: var(--space-lg);
      }
      
      .modal-content h2 {
        font-size: 22px;
      }
      
      .form-control,
      .file-upload-btn,
      .start-btn {
        padding: 15px;
      }
      
      .user-name,
      .ai-name {
        font-size: 12px;
        padding: 6px 12px;
      }
      
      .bubble {
        padding: 10px 14px;
        font-size: 14px;
      }
      
      .message {
        max-width: 95%;
      }
      
      .media-grid {
        grid-template-columns: 1fr;
      }
      
      .gallery-sidebar {
        width: 90vw;
      }
      
      .current-listing {
        font-size: 12px;
        padding: 6px 12px;
      }
    }
    
    /* Very Small Mobile (360px and below) */
    @media (max-width: 360px) {
      .modal-content {
        padding: var(--space-md);
      }
      
      .modal-content h2 {
        font-size: 20px;
        margin-bottom: var(--space-md);
      }
      
      .form-control,
      .file-upload-btn,
      .start-btn {
        padding: 12px;
      }
      
      .user-name,
      .ai-name {
        font-size: 11px;
        padding: 4px 10px;
      }
      
      .bubble {
        padding: 8px 12px;
        font-size: 13px;
      }
      
      .chat-container {
        padding: var(--space-sm);
      }
      
      .input-area {
        padding: var(--space-sm);
      }
    }
    
    /* Touch device optimizations */
    @media (hover: none) and (pointer: coarse) {
      .action-btn,
      .upload-btn,
      .input-area button,
      .listing-item,
      .file-upload-btn,
      .sidebar-toggle,
      .media-grid-item,
      .start-btn {
        min-height: 48px;
      }
      
      .input-area input,
      .form-control {
        min-height: 52px;
      }
      
      .sidebar-toggle {
        padding: 16px 8px;
      }
      
      /* Use :active instead of :hover for touch devices */
      .action-btn:active,
      .upload-btn:active,
      .input-area button:active,
      .listing-item:active,
      .start-btn:active,
      .sidebar-toggle:active,
      .media-grid-item:active {
        transform: scale(0.98);
        opacity: 0.9;
      }
      
      /* Remove hover effects on touch devices */
      .action-btn:hover,
      .upload-btn:hover,
      .input-area button:hover,
      .listing-item:hover,
      .start-btn:hover,
      .sidebar-toggle:hover,
      .media-grid-item:hover {
        transform: none;
      }
    }
    
    /* Desktop hover effects */
    @media (hover: hover) {
      .action-btn:hover,
      .upload-btn:hover,
      .input-area button:hover,
      .listing-item:hover,
      .start-btn:hover,
      .media-grid-item:hover {
        transform: translateY(-2px);
      }
      
      .sidebar-toggle:hover {
        transform: translateY(-50%) scale(1.05);
      }
    }
  </style>
</head>
<body>

  <!-- Login Modal -->
  <div id="loginModal">
    <div class="modal-content">
      <h2>Start Chatting</h2>
      
      <div class="form-group">
        <label for="userName">Your Name</label>
        <input type="text" id="userName" class="form-control" placeholder="Enter your name" value="User" />
      </div>
      
      <div class="form-group">
        <label for="aiName">AI Assistant Name</label>
        <input type="text" id="aiName" class="form-control" placeholder="Enter AI name" value="AI Assistant" />
      </div>
      
      <div class="form-group">
        <label>AI Profile Picture (Optional)</label>
        <div class="profile-pic-section">
          <div id="aiProfilePreview" class="profile-preview">
            <span style="color: var(--muted-foreground); font-size: 12px;">No Image</span>
          </div>
          <div class="profile-pic-upload">
            <label class="file-upload-btn">
              Choose Image
              <input type="file" id="aiProfilePic" accept="image/*" style="display: none;" />
            </label>
          </div>
        </div>
      </div>
      
      <button class="start-btn" onclick="startChat()">Start Chat</button>
    </div>
  </div>

  <!-- Main Chat Interface -->
  <div id="mainChat" class="hidden">
    <!-- Sidebar Toggle Button -->
    <button class="sidebar-toggle" onclick="toggleSidebar()">
      <span style="font-size: 14px;">‚ñ∂</span>
    </button>
    
    <!-- Gallery Sidebar -->
    <div class="gallery-sidebar">
      <div class="gallery-header">
        <h3>Media Gallery</h3>
      </div>
      
      <!-- Action Buttons -->
      <div class="gallery-actions">
        <button class="action-btn refresh" onclick="refreshListings()">
          <span>üîÑ</span> Restart
        </button>
        <button class="action-btn shutdown" onclick="shutdownServer()">
          <span>‚èª</span> Shutdown
        </button>
      </div>
      
      <div class="upload-section">
        <h4>Upload ZIP File</h4>
        <input type="file" id="zipUpload" accept=".zip" style="display: none;" />
        <button class="upload-btn" onclick="document.getElementById('zipUpload').click()">
          <span>üì§</span> Upload ZIP
        </button>
        <div class="upload-progress">
          <div class="upload-progress-bar"></div>
        </div>
        <div class="upload-status"></div>
      </div>
      
      <div class="listings-container" id="listingsContainer">
        <!-- Listings will be loaded here -->
        <div style="text-align: center; padding: 20px; color: var(--muted-foreground);">
          No listings available. Upload a ZIP file to get started.
        </div>
      </div>
    </div>
    
    <!-- Sidebar Overlay for Mobile -->
    <div class="sidebar-overlay" onclick="toggleSidebar()"></div>
    
    <!-- Chat Main Area -->
    <div class="chat-main">
      <!-- Header -->
      <div class="header">
        <div class="user-info">
          <span>üë§</span>
          <span id="displayUserName" class="user-name">User</span>
        </div>
        
        <div class="current-listing" id="currentListingDisplay">
          No listing selected
        </div>
        
        <div class="ai-info">
          <img id="displayAiPic" class="ai-pic" src="" alt="AI" />
          <span id="displayAiName" class="ai-name">AI Assistant</span>
        </div>
      </div>

      <!-- Chat Messages -->
      <div id="chat" class="chat-container">
        <!-- Messages will be added here dynamically -->
      </div>

      <!-- Typing Indicator -->
      <div id="typingIndicator" class="typing-indicator hidden">
        <img id="typingAiPic" class="profile-pic" src="" alt="AI" />
        <div class="typing-dots">
          <span></span>
          <span></span>
          <span></span>
        </div>
      </div>

      <!-- Input Area -->
      <div class="input-area">
        <input id="messageInput" type="text" placeholder="Type your message here..." />
        <button onclick="sendMessage()">
          <span>Send</span>
          <span>‚û§</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Toast Container -->
  <div id="toast" class="toast">
    <div class="toast-title" id="toastTitle"></div>
    <div class="toast-description" id="toastDescription"></div>
  </div>

  <script>
    // DOM Elements
    const loginModal = document.getElementById("loginModal");
    const mainChat = document.getElementById("mainChat");
    const chat = document.getElementById("chat");
    const input = document.getElementById("messageInput");
    const typingIndicator = document.getElementById("typingIndicator");
    const typingAiPic = document.getElementById("typingAiPic");
    const listingsContainer = document.getElementById("listingsContainer");
    const currentListingDisplay = document.getElementById("currentListingDisplay");
    const zipUploadInput = document.getElementById("zipUpload");
    const sidebar = document.querySelector('.gallery-sidebar');
    const toast = document.getElementById('toast');
    const toastTitle = document.getElementById('toastTitle');
    const toastDescription = document.getElementById('toastDescription');
    
    // User/AI Info
    let userName = "User";
    let aiName = "AI Assistant";
    let aiProfilePic = null;
    let backendUrl = "https://codersmitramandal.shop";
    
    // WebSocket connection
    let socket = null;
    
    // Current state
    let currentListing = null;
    let currentListingFiles = [];
    let allListings = [];
    let conversationHistory = [];
    
    // Media file extensions
    const IMAGE_EXTENSIONS = ['.jpg', '.jpeg', '.png', '.gif', '.bmp', '.webp'];
    const VIDEO_EXTENSIONS = ['.mp4', '.webm', '.mov', '.avi', '.mkv'];
    
    // Initialize event listeners
    function initEventListeners() {
      // Handle AI profile picture upload
      document.getElementById("aiProfilePic").addEventListener("change", function(event) {
        const file = event.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = function(e) {
            aiProfilePic = e.target.result;
            document.getElementById("aiProfilePreview").innerHTML = 
              `<img src="${aiProfilePic}" alt="AI Profile" />`;
          };
          reader.readAsDataURL(file);
        }
      });
      
      // Handle ZIP file upload
      zipUploadInput.addEventListener("change", async function(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        if (!file.name.endsWith('.zip')) {
          showToast('Please select a ZIP file', 'error');
          return;
        }
        
        await uploadZipFile(file);
      });
      
      // Send message on Enter key
      input.addEventListener("keydown", (e) => {
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      });
    }
    
    // Toast function from StoryScape
    function showToast(title, description, isError = false) {
      toastTitle.textContent = title;
      toastDescription.textContent = description;
      toast.className = isError ? 'toast error show' : 'toast show';
      
      setTimeout(() => {
        toast.classList.remove('show');
      }, 5000);
    }
    
    // Toggle sidebar function
    function toggleSidebar() {
      sidebar.classList.toggle('open');
      document.body.classList.toggle('sidebar-open');
      const toggleBtn = document.querySelector('.sidebar-toggle span');
      toggleBtn.textContent = sidebar.classList.contains('open') ? '‚óÄ' : '‚ñ∂';
    }
    
    // Refresh listings function
    async function refreshListings() {
      try {
        const response = await fetch(backendUrl + '/ayc/restart', {
          method: 'GET'
        });
        
        if (response.ok) {
          const data = await response.json();
          allListings = data.folders.map(folder => ({
            name: folder,
            description: `Media collection uploaded on ${new Date().toLocaleDateString()}`,
            files: []
          }));
          
          // Load files for each listing
          for (let listing of allListings) {
            try {
              const filesResponse = await fetch(backendUrl + '/ayc/list-files/' + listing.name);
              if (filesResponse.ok) {
                const filesData = await filesResponse.json();
                listing.files = filesData.files || [];
              }
            } catch (error) {
              console.error(`Error loading files for ${listing.name}:`, error);
            }
          }
          
          renderListings();
          showToast('Listings refreshed successfully!', 'success');
          
          // Re-select current listing if it exists
          if (currentListing) {
            const updatedListing = allListings.find(l => l.name === currentListing.name);
            if (updatedListing) {
              selectListing(updatedListing);
            }
          }
        } else {
          showToast('Failed to refresh listings', 'error');
        }
      } catch (error) {
        console.error('Error refreshing listings:', error);
        showToast('Error refreshing listings', 'error');
      }
    }
    
    // Shutdown server function
    async function shutdownServer() {
      if (!confirm('Are you sure you want to shutdown the server? This will terminate the backend service.')) {
        return;
      }
      
      try {
        const response = await fetch(backendUrl + '/ayc/shutdown', {
          method: 'GET'
        });
        
        if (response.ok) {
          showToast('Server shutdown initiated...', 'success');
          addMessage('Server shutdown initiated. The backend service will stop shortly.', 'bot', aiName, aiProfilePic);
          
          // Close WebSocket connection
          if (socket && socket.readyState === WebSocket.OPEN) {
            socket.close();
          }
        } else {
          showToast('Failed to shutdown server', 'error');
        }
      } catch (error) {
        console.error('Error shutting down server:', error);
        showToast('Error shutting down server', 'error');
      }
    }
    
    async function uploadZipFile(file) {
      const formData = new FormData();
      formData.append('file', file);
      
      const progressBar = document.querySelector('.upload-progress-bar');
      const progressContainer = document.querySelector('.upload-progress');
      const statusElement = document.querySelector('.upload-status');
      
      progressContainer.style.display = 'block';
      statusElement.style.display = 'block';
      statusElement.textContent = 'Uploading...';
      statusElement.style.color = 'var(--info)';
      progressBar.style.width = '30%';
      
      try {
        const response = await fetch(backendUrl + '/ayc/upload-zip', {
          method: 'POST',
          body: formData
        });
        
        progressBar.style.width = '70%';
        
        if (!response.ok) {
          throw new Error(`Upload failed: ${response.status}`);
        }
        
        const result = await response.json();
        progressBar.style.width = '100%';
        statusElement.textContent = 'Upload successful! Loading listing...';
        statusElement.style.color = 'var(--success)';
        
        // Load the newly uploaded listing
        await loadListings();
        
        // Find and select the new listing
        const newListing = allListings.find(l => l.name === result.folder);
        if (newListing) {
          selectListing(newListing);
        }
        
        setTimeout(() => {
          progressContainer.style.display = 'none';
          statusElement.style.display = 'none';
          progressBar.style.width = '0%';
        }, 2000);
        
      } catch (error) {
        console.error('Upload error:', error);
        progressBar.style.width = '0%';
        statusElement.textContent = `Error: ${error.message}`;
        statusElement.style.color = 'var(--error)';
        
        setTimeout(() => {
          progressContainer.style.display = 'none';
          statusElement.style.display = 'none';
        }, 3000);
      }
    }
    
    function showUploadStatus(message, type = 'info') {
      const statusElement = document.querySelector('.upload-status');
      statusElement.textContent = message;
      statusElement.style.color = `var(--${type})`;
      statusElement.style.display = 'block';
      
      setTimeout(() => {
        statusElement.style.display = 'none';
      }, 3000);
    }
    
    // Start chat function
    async function startChat() {
      // Get user input
      userName = document.getElementById("userName").value.trim() || "User";
      aiName = document.getElementById("aiName").value.trim() || "AI Assistant";
      
      // Update display
      document.getElementById("displayUserName").textContent = userName;
      document.getElementById("displayAiName").textContent = aiName;
      
      // Update AI profile picture if selected
      if (aiProfilePic) {
        document.getElementById("displayAiPic").src = aiProfilePic;
        typingAiPic.src = aiProfilePic;
      } else {
        // Set default AI avatar
        const defaultAvatar = `https://ui-avatars.com/api/?name=${encodeURIComponent(aiName)}&background=6366f1&color=fff&size=128`;
        document.getElementById("displayAiPic").src = defaultAvatar;
        typingAiPic.src = defaultAvatar;
      }
      
      // Hide login modal, show chat
      loginModal.classList.add("hidden");
      mainChat.classList.remove("hidden");
      
      // Initialize event listeners
      initEventListeners();
      
      // Load listings from server
      await loadListings();
      
      // Initialize WebSocket connection
      initializeWebSocket();
      
      // Focus on input
      setTimeout(() => {
        input.focus();
      }, 300);
    }
    
    // Load listings from server
    async function loadListings() {
      try {
        const response = await fetch(backendUrl + '/ayc/list-folders', {
          method: 'GET'
        });
        
        if (response.ok) {
          const data = await response.json();
          allListings = data.folders.map(folder => ({
            name: folder,
            description: `Media collection uploaded on ${new Date().toLocaleDateString()}`,
            files: []
          }));
          
          // Load files for each listing
          for (let listing of allListings) {
            try {
              const filesResponse = await fetch(backendUrl + '/ayc/list-files/' + listing.name);
              if (filesResponse.ok) {
                const filesData = await filesResponse.json();
                listing.files = filesData.files || [];
              }
            } catch (error) {
              console.error(`Error loading files for ${listing.name}:`, error);
            }
          }
          
          renderListings();
        } else {
          // Fallback to sample data
          allListings = [
            {
              name: "sample_listing",
              description: "Sample media collection",
              files: ["image1.jpg", "image2.png", "video1.mp4"]
            }
          ];
          renderListings();
        }
      } catch (error) {
        console.error('Error loading listings:', error);
        allListings = [];
        renderListings();
      }
    }
    
    // Render listings in sidebar
    function renderListings() {
      listingsContainer.innerHTML = '';
      
      if (allListings.length === 0) {
        listingsContainer.innerHTML = `
          <div style="text-align: center; padding: 20px; color: var(--muted-foreground);">
            No listings available. Upload a ZIP file to get started.
          </div>
        `;
        return;
      }
      
      allListings.forEach(listing => {
        const listingElement = document.createElement('div');
        listingElement.className = `listing-item ${currentListing?.name === listing.name ? 'active' : ''}`;
        listingElement.innerHTML = `
          <div class="listing-title">${listing.name}</div>
          <div class="listing-description">${listing.description}</div>
          <div class="listing-meta">
            <span>${formatDate(new Date())}</span>
            <span class="media-count">${listing.files.length} files</span>
          </div>
          ${currentListing?.name === listing.name ? '<div class="selected-badge">Selected</div>' : ''}
        `;
        
        listingElement.addEventListener('click', () => {
          selectListing(listing);
          if (window.innerWidth <= 767) {
            toggleSidebar();
          }
        });
        listingsContainer.appendChild(listingElement);
      });
    }
    
    // Select a listing
    async function selectListing(listing) {
      currentListing = listing;
      currentListingFiles = listing.files.filter(file => isMediaFile(file));
      
      // Update display
      currentListingDisplay.textContent = `üì∑ ${listing.name} (${currentListingFiles.length} media files)`;
      
      // Update active state in sidebar
      document.querySelectorAll('.listing-item').forEach(item => {
        item.classList.remove('active');
      });
      
      const selectedItem = Array.from(document.querySelectorAll('.listing-item'))
        .find(item => item.querySelector('.listing-title').textContent === listing.name);
      
      if (selectedItem) {
        selectedItem.classList.add('active');
      }
    }
    
    // Check if file is media
    function isMediaFile(filename) {
      if (!filename || typeof filename !== 'string') return false;
      const ext = filename.toLowerCase().substring(filename.lastIndexOf('.'));
      return IMAGE_EXTENSIONS.includes(ext) || VIDEO_EXTENSIONS.includes(ext);
    }
    
    // Get random media from current listing
    function getRandomMedia(count = 1) {
      if (!currentListingFiles.length) return [];
      
      const shuffled = [...currentListingFiles].sort(() => 0.5 - Math.random());
      return shuffled.slice(0, Math.min(count, shuffled.length));
    }
    
    // Get file URL for display
    function getFileUrl(filename) {
      return backendUrl + '/ayc/read-file/' + currentListing.name + '/' + encodeURIComponent(filename);
    }
    
    // Initialize WebSocket connection
    function initializeWebSocket() {
      const wsUrl = "wss://codersmitramandal.shop/ayc/personal_chat";
      socket = new WebSocket(wsUrl);
      
      socket.onopen = () => {
        console.log("WebSocket connected");
        setTimeout(() => {
          addMessage(`Hello ${userName}! I'm ${aiName}, ready to chat with you!`, "bot", aiName, aiProfilePic);
        }, 500);
      };
      
      socket.onmessage = (event) => {
        try {
          const data = JSON.parse(event.data);
          typingIndicator.classList.add("hidden");
          
          if (data.response) {
            // Randomly add media to responses
            const shouldAddMedia = Math.random() > 0.6 && currentListingFiles.length > 0;
            
            if (shouldAddMedia) {
              const randomMedia = getRandomMedia(Math.floor(Math.random() * 2) + 1);
              addMessageWithMedia(data.response, randomMedia, "bot", aiName, aiProfilePic);
            } else {
              addMessage(data.response, "bot", aiName, aiProfilePic);
            }
          } else if (data.error) {
            addMessage("Error: " + data.error, "bot", aiName, aiProfilePic);
          }
        } catch (error) {
          console.error("Error parsing WebSocket message:", error);
        }
      };
      
      socket.onerror = (err) => {
        console.error("WebSocket error:", err);
        typingIndicator.classList.add("hidden");
        addMessage("Connection error. Please try again.", "bot", aiName, aiProfilePic);
      };
      
      socket.onclose = () => {
        console.log("WebSocket disconnected");
      };
    }
    
    // Send message function
    function sendMessage() {
      const text = input.value.trim();
      if (!text || !socket || socket.readyState !== WebSocket.OPEN) return;
      
      // Add user message
      addMessage(text, "user", userName, null);
      
      // Send via WebSocket
      socket.send(JSON.stringify({ question: text }));
      
      // Show typing indicator
      typingIndicator.classList.remove("hidden");
      
      // Clear input
      input.value = "";
      input.focus();
    }
    
    // Add message to chat
    function addMessage(text, senderType, senderName, senderPic) {
      const messageDiv = createMessageElement(text, senderType, senderName, senderPic);
      chat.appendChild(messageDiv);
      scrollToBottom();
      
      conversationHistory.push({
        type: senderType,
        name: senderName,
        text: text,
        timestamp: new Date()
      });
    }
    
    // Add message with media
    function addMessageWithMedia(text, mediaFiles, senderType, senderName, senderPic) {
      const messageDiv = createMessageElement(text, senderType, senderName, senderPic);
      
      if (mediaFiles.length > 0) {
        const mediaContainer = document.createElement('div');
        mediaContainer.className = 'media-container';
        
        if (mediaFiles.length === 1) {
          const mediaFile = mediaFiles[0];
          const ext = mediaFile.toLowerCase().substring(mediaFile.lastIndexOf('.'));
          
          if (IMAGE_EXTENSIONS.includes(ext)) {
            mediaContainer.innerHTML = `
              <img class="media-item" src="${getFileUrl(mediaFile)}" alt="${mediaFile}" loading="lazy" />
              <div class="media-label">From ${currentListing.name}: ${mediaFile}</div>
            `;
          } else if (VIDEO_EXTENSIONS.includes(ext)) {
            mediaContainer.innerHTML = `
              <video class="media-item" controls playsinline>
                <source src="${getFileUrl(mediaFile)}" type="video/${ext.substring(1)}">
                Your browser does not support the video tag.
              </video>
              <div class="media-label">From ${currentListing.name}: ${mediaFile}</div>
            `;
          }
        } else {
          const mediaGrid = document.createElement('div');
          mediaGrid.className = 'media-grid';
          
          mediaFiles.forEach(mediaFile => {
            const ext = mediaFile.toLowerCase().substring(mediaFile.lastIndexOf('.'));
            const gridItem = document.createElement('div');
            gridItem.className = 'media-grid-item';
            
            if (IMAGE_EXTENSIONS.includes(ext)) {
              gridItem.innerHTML = `<img src="${getFileUrl(mediaFile)}" alt="${mediaFile}" loading="lazy" />`;
            } else if (VIDEO_EXTENSIONS.includes(ext)) {
              gridItem.innerHTML = `
                <video>
                  <source src="${getFileUrl(mediaFile)}" type="video/${ext.substring(1)}">
                </video>
                <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: white; background: rgba(0,0,0,0.7); width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center;">‚ñ∂</div>
              `;
            }
            
            mediaGrid.appendChild(gridItem);
          });
          
          mediaContainer.appendChild(mediaGrid);
          const label = document.createElement('div');
          label.className = 'media-label';
          label.textContent = `From ${currentListing.name} collection`;
          mediaContainer.appendChild(label);
        }
        
        messageDiv.appendChild(mediaContainer);
      }
      
      chat.appendChild(messageDiv);
      scrollToBottom();
      
      conversationHistory.push({
        type: senderType,
        name: senderName,
        text: text,
        media: mediaFiles,
        timestamp: new Date()
      });
    }
    
    // Create message element
    function createMessageElement(text, senderType, senderName, senderPic) {
      const messageDiv = document.createElement("div");
      messageDiv.className = `message ${senderType}`;
      
      const headerDiv = document.createElement("div");
      headerDiv.className = "message-header";
      
      let picSrc = senderPic;
      if (!picSrc && senderType === "bot") {
        picSrc = `https://ui-avatars.com/api/?name=${encodeURIComponent(senderName)}&background=6366f1&color=fff&size=128`;
      }
      
      if (senderType === "bot" && picSrc) {
        headerDiv.innerHTML = `<img class="profile-pic" src="${picSrc}" alt="${senderName}" />
                               <span class="name">${senderName}</span>`;
      } else {
        headerDiv.innerHTML = `<span class="name">${senderName}</span>`;
      }
      
      const bubbleDiv = document.createElement("div");
      bubbleDiv.className = "bubble";
      bubbleDiv.textContent = text;
      
      const timeDiv = document.createElement("div");
      timeDiv.className = "message-time";
      timeDiv.textContent = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      
      messageDiv.appendChild(headerDiv);
      messageDiv.appendChild(bubbleDiv);
      messageDiv.appendChild(timeDiv);
      
      return messageDiv;
    }
    
    // Scroll to bottom of chat
    function scrollToBottom() {
      requestAnimationFrame(() => {
        chat.scrollTop = chat.scrollHeight;
      });
    }
    
    // Format date
    function formatDate(date) {
      return date.toLocaleDateString('en-US', { 
        month: 'short', 
        day: 'numeric',
        year: 'numeric'
      });
    }
  </script>
</body>
</html>

